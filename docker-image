const amqp = require("amqplib");

async function connectSecure() {
  try {
    const amqpsUrl = process.env.RABBIT_AMQPS_URL;

    // Base64 CA → Buffer → string
    const caDecoded = Buffer.from(process.env.CA_CERT_BASE64, "base64").toString("utf8");

    const conn = await amqp.connect(amqpsUrl, {
      ca: [caDecoded],
      rejectUnauthorized: true
    });

    console.log("✔ AMQPS connected with Base64 CA");
    await conn.close();
  } catch (err) {
    console.error("✘ AMQPS connection failed:", err);
  }
}

connectSecure();
